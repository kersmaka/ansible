---
- name: Find AAP Installation Host
  hosts: aap26Fresh
  gather_facts: no
  tasks:
    - name: Check for AAP installation directory
      stat:
        path: "/home/aap/ansible-automation-platform-containerized-setup-bundle-2.6-1.1-x86_64"
      register: aap_dir_check
      ignore_errors: yes

    - name: Register host with AAP installation
      set_fact:
        has_aap: true
        aap_path: "{{ aap_dir_check.stat.path if aap_dir_check.stat.exists else (aap_search.files[0].path if aap_search.files is defined and aap_search.files | length > 0 else '') }}"
      when: aap_dir_check.stat.exists or (aap_search.files is defined and aap_search.files | length > 0)

    - name: Run AAP containerized backup
      shell: |
        cd {{ aap_path }}
        ansible-playbook -i inventory ansible.containerized_installer.restore 2>&1
      args:
        chdir: "{{ aap_path }}"
        executable: /bin/bash
      become: yes
      become_user: aap
      register: backup_result
      changed_when: true
      failed_when: false
