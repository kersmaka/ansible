# --- STEP 1: BACKUP SOURCE ---
# --- PRE-BACKUP SECRETS PREPARATION ---
- name: Create the artifact directory
  ansible.builtin.file:
    path: "/home/aap/artifact"
    state: directory
    mode: '0755'
  become: true

- name: Generate secrets.yml from AAP variables
  ansible.builtin.copy:
    # This pulls the value directly from your Job Template's extra variables
    content: |
      controller_secret_key: "{{ controller_secret_key }}"
    dest: "/home/aap/artifact/secrets.yml"
    mode: '0600'
  become: true

- name: Debug secrets file content (Temporary)
  ansible.builtin.command: cat /home/aap/artifact/secrets.yml
  register: secrets_contents
  become: true

- name: Show secrets content in AAP logs
  ansible.builtin.debug:
    var: secrets_contents.stdout  

- name: Execute AAP Backup Playbook
  ansible.builtin.command:
    cmd: ansible-playbook -i inventory ansible.containerized_installer.backup -e "@/home/aap/artifact/secrets.yml"
    chdir: "/home/aap/ansible-automation-platform-containerized-setup-bundle-2.6-1.1-x86_64"  # <--- Add the path to where the inventory file lives
  register: backup_output
- name: Find the generated backup file
  ansible.builtin.find:
    paths: "{{ backup_file_path }}"
    patterns: "automation-platform-backup-*.tar.gz"
  register: found_backups
- name: Set backup filename variable
  ansible.builtin.set_fact:
    latest_backup: "{{ found_backups.files | sort(attribute='mtime', reverse=True) | first }}"

- name: Remove temporary secrets file
  ansible.builtin.file:
    path: "/home/aap/artifact/secrets.yml"
    state: absent
  become: true    
    
# --- STEP 2: TRANSFER ---
- name: Fetch backup from source to local
  ansible.builtin.fetch:
    src: "{{ hostvars['source_host']['latest_backup']['path'] }}"
    dest: "/tmp/migration_temp.tar.gz"
    flat: yes
- name: Copy backup to destination host
  ansible.builtin.copy:
    src: "/tmp/migration_temp.tar.gz"
    dest: "/tmp/aap_restore_file.tar.gz"
    delegate_to: destination_host

# --- STEP 3: RESTORE ON DESTINATION ---
- name: Execute AAP Restore Playbook
  ansible.builtin.command:
    cmd: >
      ansible-playbook -i inventory ansible.containerized_installer.restore 
      -e "restore_backup_file=/tmp/aap_restore_file.tar.gz"
  register: restore_output