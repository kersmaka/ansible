---
- name: Ensure FreeIPA client package is installed
  ansible.builtin.package:
    name: ipa-client
    state: present

- name: Check if the node is already enrolled in FreeIPA
  ansible.builtin.stat:
    path: /etc/ipa/default.conf
  register: ipa_config

- name: Enroll node in FreeIPA domain
  community.general.ipa_client:
    state: present
    domain: "{{ ipa_domain | default('HOME.LAN') }}"
    realm: "{{ ipa_realm | default('HOME.LAN') }}"
    server: "{{ ipa_server }}"
    principal: "{{ ipa_admin_user | default('admin') }}"
    password: "{{ ipa_admin_password }}"
    mkhomedir: yes
    ntp_servers: "{{ ipa_server }}" # Explicitly sync time to the server
  # The module is smart enough to skip if already enrolled

- name: Ensure SSSD service is started and enabled
  ansible.builtin.service:
    name: sssd
    state: started
    enabled: yes