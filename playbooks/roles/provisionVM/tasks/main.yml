---
- name: Ensure destination directory exists
  ansible.builtin.file:
    path: "/home/ansible_admin/vms/qcow2/"
    state: directory
    mode: '0755'

- name: Check if VM already exists
  ansible.builtin.command: virsh dominfo {{ vm_name }}
  register: vm_check
  ignore_errors: true
  changed_when: false

- name: Copy and Configure VM
  block:
    - name: Copy qcow2 image
      ansible.builtin.copy:
        src: "{{ source_image }}"
        dest: "{{ dest_image }}"
        remote_src: true
        force: false

    - name: Inject Configuration
      ansible.builtin.command: >
        virt-customize -a {{ dest_image }}
        --hostname {{ vm_name }}
        --run-command "subscription-manager register --force --username {{ vault_rh_user }} --password '{{ vault_rh_password }}'"
        --run-command "dnf update -y"

    - name: Run virt-install
      ansible.builtin.command: >
        virt-install --name {{ vm_name }} --ram {{ vm_memory }} --vcpus {{ vm_vcpus }}
        --disk path={{ dest_image }},format=qcow2 --import --os-variant rhel9.0
        --network network=br0-network --graphics none --noautoconsole

    - name: Wait for initialization
      ansible.builtin.pause:
        seconds: 60  # Allows the VM to fully obtain a DHCP lease

    - name: Get VM IP
      ansible.builtin.shell: "/home/tools/ipCheck.sh {{ vm_name }}"
      register: ip_output

    - name: Add new VM to /etc/hosts on kvm_host
      ansible.builtin.lineinfile:
        path: /etc/hosts
        # Match lines ending with the VM name to prevent duplicates
        regexp: ".*{{ vm_name }}$"
        # Extract only the IP address from the messy ipCheck.sh output
        line: "{{ ip_output.stdout | regex_search('IP: (\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})', '\\1') | first }}    {{ vm_name }}"
        state: present
      become: yes  # Required for root access to /etc/hosts
  when: vm_check.rc != 0

- name: Share IP with subsequent plays
  ansible.builtin.set_stats:
    data:
      # Pass the cleaned IP to subsequent roles
      new_vm_ip: "{{ ip_output.stdout | regex_search('IP: (\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})', '\\1') | first }}"
  when: vm_check.rc != 0 and ip_output is defined