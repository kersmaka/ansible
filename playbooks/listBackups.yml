---
- name: Restore Ansible Automation Platform from Backup
  hosts: all
  gather_facts: yes
  vars:
    # --- REQUIRED INPUT ---
    # Set this to the timestamp folder name of the backup you wish to restore.
    # Examples: 20251126_201320 or 20251126_201557
    backup_timestamp: "LATEST" # Default to 'LATEST', which you should override in the prompt
    
    # --- CONFIGURATION ---
    # Base path for the AAP setup bundle
    aap_setup_dir: "/home/aap/ansible-automation-platform-containerized-setup-bundle-2.6-1.1-x86_64"
    
    # Path where the backups are stored inside the setup directory
    aap_backup_base_path: "{{ aap_setup_dir }}/backups"

  tasks:
    - name: Fail if backup_timestamp is set to default 'LATEST'
      fail:
        msg: "❌ ERROR: You must specify the 'backup_timestamp' variable with the exact folder name (e.g., 20251126_201320) to restore from."
      when: backup_timestamp == "LATEST"

    - name: Set full path to the backup directory
      set_fact:
        full_backup_path: "{{ aap_backup_base_path }}/{{ backup_timestamp }}"

    - name: Check if the specified backup directory exists
      stat:
        path: "{{ full_backup_path }}"
      register: backup_dir_stat

    - name: Fail if backup directory does not exist
      fail:
        msg: "❌ ERROR: The backup directory '{{ full_backup_path }}' does not exist. Check the timestamp variable."
      when: not backup_dir_stat.stat.exists or not backup_dir_stat.stat.isdir

    - name: Stop AAP services before restore
      ansible.builtin.shell: |
        cd {{ aap_setup_dir }}
        ./setup.sh -b --no-log --stop
      args:
        chdir: "{{ aap_setup_dir }}"
      changed_when: true
      become: yes
      become_user: root # Must run as root to manage system services/containers

    - name: Run AAP setup script with restore flag
      ansible.builtin.shell: |
        # The setup.sh script handles the restoration process by unpacking the archives
        # located in the specified --restore-from directory.
        ./setup.sh -b --no-log --restore-from {{ full_backup_path }}
      args:
        chdir: "{{ aap_setup_dir }}"
        # Set a long timeout for the restoration process
        # Restoration can take significant time depending on database size.
        timeout: 3600 
      changed_when: true
      become: yes
      become_user: root # Must run as root to run setup.sh

    - name: Check restoration status
      debug:
        msg: "✅ AAP restoration is complete. The system is restarting with data from backup timestamp: {{ backup_timestamp }}"
