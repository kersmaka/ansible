---
- name: Restore Ansible Automation Platform
  hosts: all
  gather_facts: yes
  vars:
    # Set the path to the backup directory or file you wish to restore.
    # CHANGED: Updated to point to the directory containing component backups (20251126_201557)
    restore_backup_file: "{{ aap_path }}/backups/20251126_201557" 
    
  tasks:
    - name: Skip hosts without AAP installation
      meta: end_host
      when: has_aap is not defined or not has_aap

    - name: Display restore configuration
      debug:
        msg:
          - "=== Starting AAP Restore ==="
          - "Host: {{ inventory_hostname }}"
          - "Directory: {{ aap_path }}"
          - "Backup Location: {{ restore_backup_file }}"

    - name: Verify inventory file exists
      stat:
        path: "{{ aap_path }}/inventory"
      register: inventory_file

    - name: Fail if inventory file missing
      fail:
        msg: "Inventory file not found at {{ aap_path }}/inventory"
      when: not inventory_file.stat.exists

    - name: Verify backup file/directory exists
      stat:
        path: "{{ restore_backup_file }}"
      register: backup_file
      
    - name: Fail if backup file/directory missing
      fail:
        msg: "Backup location not found at {{ restore_backup_file }}. Please update the 'restore_backup_file' variable."
      when: not backup_file.stat.exists

    - name: Display restore command
      debug:
        msg: 
          - "Command: time cd {{ aap_path }} && ansible-playbook -i inventory ansible.containerized_installer.restore -kK -e backup_file={{ restore_backup_file }}"

    - name: Run AAP containerized restore with -kK and time
      shell: |
        time ansible-playbook -i inventory ansible.containerized_installer.restore -kK \
          -e backup_file={{ restore_backup_file | quote }} 2>&1
      args:
        chdir: "{{ aap_path }}"
        executable: /bin/bash
      become: yes
      # The restore command typically needs to be run as the user that owns the AAP files, often 'aap'.
      become_user: aap
      register: restore_result
      changed_when: true
      failed_when: false # Allow us to check RC later

    - name: Display result
      debug:
        msg:
          - "=== Restore Complete ==="
          - "Host: {{ inventory_hostname }}"
          - "Return Code: {{ restore_result.rc }}"
          - "Check output for details."

    - name: Success
      debug:
        msg: "✓ Restore completed successfully on {{ inventory_hostname }}!"
      when: restore_result.rc == 0

    - name: Warning on error
      debug:
        msg: "⚠ WARNING: Restore had errors (RC: {{ restore_result.rc }}). Check the output for details."
      when: restore_result.rc != 0

    - name: Fail if critical error
      fail:
        msg: "Restore failed critically with RC {{ restore_result.rc }}"
      when: restore_result.rc != 0 and restore_result.rc > 2
