---
- name: Restore Ansible Automation Platform from Backup
  # Set hosts to the target server where AAP is installed (e.g., [automation_controller])
  # If running against the server itself, 'localhost' is also an option, but 'all' works fine
  # if your inventory only contains the AAP host.
  hosts: all 
  gather_facts: yes
  vars:
    # --- REQUIRED INPUT ---
    # Set this to the timestamp folder name of the backup you wish to restore.
    # Examples: 20251126_201320 or 20251126_201557
    backup_timestamp: "LATEST" # Default to 'LATEST', which you should override in the prompt
    
    # --- CONFIGURATION ---
    # Base path for the AAP setup bundle (contains inventory and playbooks)
    aap_setup_dir: "/home/aap/ansible-automation-platform-containerized-setup-bundle-2.6-1.1-x86_64"
    
    # Path where the backups are stored inside the setup directory
    aap_backup_base_path: "{{ aap_setup_dir }}/backups"
    
    # Inventory file name relative to the aap_setup_dir
    aap_inventory_file: "inventory" 

  tasks:
    - name: Fail if backup_timestamp is set to default 'LATEST'
      fail:
        msg: |
          ❌ ERROR: The 'backup_timestamp' variable must be set.
          When launching this Job Template, please provide the backup folder name 
          (e.g., 20251126_201320) as an Extra Variable.
          
          You can use the 'List Available AAP Backups' job to find valid timestamps.
      when: backup_timestamp == "LATEST"

    - name: Set full path to the backup directory
      set_fact:
        full_backup_path: "{{ aap_backup_base_path }}/{{ backup_timestamp }}"

    - name: Check if the specified backup directory exists
      stat:
        path: "{{ full_backup_path }}"
      register: backup_dir_stat
      # The stat module should run as the user who owns the backup files (aap)
      become: yes
      become_user: aap 

    - name: Fail if backup directory does not exist
      fail:
        msg: "❌ ERROR: The backup directory '{{ full_backup_path }}' does not exist. Check the timestamp variable you provided."
      when: not backup_dir_stat.stat.exists or not backup_dir_stat.stat.isdir

    - name: Restore AAP using the containerized installer's playbook (FQCN method)
      # Execution is correct, but we need to ensure the AAP user is executing the command,
      # which is handled by the overall SSH connection. We will use the 'shell' module
      # with 'become_user: aap' to ensure the command is run in the correct user context 
      # where the Podman containers are visible.
      # 
      # We are explicitly running the FQCN restore playbook, passing the necessary
      # variables for the restore directory.
      ansible.builtin.shell: |
        # Use '--skip-tags services' only if the internal playbook keeps failing 
        # due to systemd unit management in your rootless environment. 
        # This is a common workaround for this specific error.
        ansible-playbook -i {{ aap_inventory_file }} ansible.containerized_installer.restore --extra-vars "restore_dir={{ full_backup_path }}" 
        
      args:
        # CRUCIAL: Must run from the setup directory to correctly find the 'inventory' file 
        # and allow the FQCN to resolve relative to the install directory's EE setup.
        chdir: "{{ aap_setup_dir }}"
      changed_when: true
      # Run as the 'aap' user, which owns the Podman containers and the setup bundle.
      # This is the most critical fix for rootless/user-managed containers.
      become: yes
      become_user: aap 
      timeout: 3600 

    - name: Check restoration status
      debug:
        msg: "✅ AAP restoration is complete. The system is restarting with data from backup timestamp: {{ backup_timestamp }}. Access the web interface once services are fully online."
